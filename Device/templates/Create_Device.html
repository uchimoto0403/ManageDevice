{% extends 'layout.html' %}
{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet" crossorigin="anonymous">

<div class="container" style="max-width:1200px;">
  <!-- メインフォーム -->
  <form id="mainForm" action="{% url 'create_device' struserid=struserid %}" method="post">
    {% csrf_token %}

    <div class="fs-4 text-center mb-4">
      <h1>機器登録</h1>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} text-center">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <!-- 入力フォーム -->
    <div class="row mb-3">
      <label class="col-2 text-end">機器名：</label>
      <div class="col-4">
        <input type="text" name="chrDeviceName" class="form-control"
               value="{{ temp_device.chrDeviceName|default:'' }}">
      </div>
      <label class="col-2 text-end">使用可否：</label>
      <div class="col-4">
        <input type="text" name="chrDeviceStatus" class="form-control"
               value="{{ temp_device.chrDeviceStatus|default:'' }}">
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">顧客名：</label>
      <div class="col-4">
        <select name="intCustomer" class="form-select" required>
          <option value="">選択してください</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}"
              {% if temp_device.intCustomer == customer.id|stringformat:"s" %}selected{% endif %}>
              {{ customer.usrName }}
            </option>
          {% endfor %}
        </select>
      </div>
      <label class="col-2 text-end">シリアル番号：</label>
      <div class="col-4">
        <input type="text" name="chrDeviceSerialNumber" class="form-control"
               value="{{ temp_device.chrDeviceSerialNumber|default:'' }}">
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">媒体：</label>
      <div class="col-4"><input type="text" name="chrDeviceKind" class="form-control"
                                value="{{ temp_device.chrDeviceKind|default:'' }}"></div>
      <label class="col-2 text-end">OS：</label>
      <div class="col-4"><input type="text" name="chrDeviceOS" class="form-control"
                                value="{{ temp_device.chrDeviceOS|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">メーカー：</label>
      <div class="col-4"><input type="text" name="chrDeviceMaker" class="form-control"
                                value="{{ temp_device.chrDeviceMaker|default:'' }}"></div>
      <label class="col-2 text-end">CPU：</label>
      <div class="col-4"><input type="text" name="chrDeviceCPU" class="form-control"
                                value="{{ temp_device.chrDeviceCPU|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">型番：</label>
      <div class="col-4"><input type="text" name="chrDeviceModel" class="form-control"
                                value="{{ temp_device.chrDeviceModel|default:'' }}"></div>
      <label class="col-2 text-end">RAM：</label>
      <div class="col-4"><input type="text" name="chrDeviceRAM" class="form-control"
                                value="{{ temp_device.chrDeviceRAM|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">購入日：</label>
      <div class="col-4"><input type="date" name="dtDevicePurchase" class="form-control"
                                value="{{ temp_device.dtDevicePurchase|default:'' }}"></div>
      <label class="col-2 text-end">グラフィックカード：</label>
      <div class="col-4"><input type="text" name="chrDeviceGraphic" class="form-control"
                                value="{{ temp_device.chrDeviceGraphic|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">保証期限：</label>
      <div class="col-4"><input type="date" name="dtDeviceWarranty" class="form-control"
                                value="{{ temp_device.dtDeviceWarranty|default:'' }}"></div>
      <label class="col-2 text-end">ストレージ：</label>
      <div class="col-4"><input type="text" name="chrDeviceStorage" class="form-control"
                                value="{{ temp_device.chrDeviceStorage|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">使用者：</label>
      <div class="col-4"><input type="text" name="chrDeviceUser" class="form-control"
                                value="{{ temp_device.chrDeviceUser|default:'' }}"></div>
      <label class="col-2 text-end">IPアドレス：</label>
      <div class="col-4"><input type="text" name="chrDeviceIP" class="form-control"
                                value="{{ temp_device.chrDeviceIP|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">設置場所：</label>
      <div class="col-4"><input type="text" name="chrDevicePlace" class="form-control"
                                value="{{ temp_device.chrDevicePlace|default:'' }}"></div>
      <label class="col-2 text-end">ネットワーク：</label>
      <div class="col-4"><input type="text" name="chrDeviceNetwork" class="form-control"
                                value="{{ temp_device.chrDeviceNetwork|default:'' }}"></div>
    </div>

    <div class="row mb-3">
      <label class="col-2 text-end">資産番号：</label>
      <div class="col-4"><input type="text" name="chrDeviceAssetNumber" class="form-control"
                                value="{{ temp_device.chrDeviceAssetNumber|default:'' }}"></div>
      <label class="col-2 text-end">ソフト登録：</label>
      <div class="col-4">
        <button type="button" class="btn btn-info btn-sm w-100"
                data-bs-toggle="modal" data-bs-target="#softwareModal">
          ソフト登録
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <label class="col-2 text-end">備考：</label>
      <div class="col-10"><textarea name="chrNotes" class="form-control">{{ temp_device.chrNotes|default:'' }}</textarea></div>
    </div>

    <div class="d-flex flex-column align-items-center gap-3 mb-5" style="max-width: 250px; margin: 0 auto;">
      <button class="btn btn-primary w-100" type="submit" name="btnCreate">登録</button>
      <button class="btn btn-secondary w-100" type="submit" name="btnBack" formnovalidate>戻る</button>
      <button class="btn btn-danger w-100" type="submit" name="btnLogout" formnovalidate>ログアウト</button>
    </div>
  </form>
</div>

<!-- ソフト登録モーダル -->
<div class="modal fade" id="softwareModal" tabindex="-1" aria-labelledby="softwareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ソフト登録</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <div class="modal-body">

        {% if temp_softs %}
          <table class="table table-bordered">
            <thead>
              <tr><th>ソフト名</th><th>保証期限</th><th>操作</th></tr>
            </thead>
            <tbody>
              {% for soft in temp_softs %}
              <tr>
                <form method="post" action="{% url 'create_device' struserid=struserid %}" class="softForm">
                  {% csrf_token %}
                  <td><input type="text" name="chrSoftName" value="{{ soft.name }}" class="form-control"></td>
                  <td><input type="date" name="chrWarranty" value="{{ soft.warranty }}" class="form-control"></td>
                  <td>
                    <input type="hidden" name="soft_index" value="{{ forloop.counter0 }}">
                    <button type="submit" name="btnUpdateSoftTemp" class="btn btn-success btn-sm">保存</button>
                    <button type="submit" name="btnDeleteSoftTemp" class="btn btn-danger btn-sm">削除</button>
                  </td>
                </form>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted">登録されたソフトはありません。</p>
        {% endif %}

        <hr>

        <!-- 新規追加フォーム -->
        <form method="post" action="{% url 'create_device' struserid=struserid %}" class="softForm">
          {% csrf_token %}
          <div class="row mb-3">
            <div class="col-5"><input type="text" name="chrSoftName" class="form-control" placeholder="ソフト名"></div>
            <div class="col-5"><input type="date" name="chrWarranty" class="form-control"></div>
            <div class="col-2"><button type="submit" name="btnAddSoftTemp" class="btn btn-primary w-100">追加</button></div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>

<!-- ★ メインフォーム内容をモーダルフォームに自動コピー -->
<script>
document.querySelectorAll('.softForm').forEach(form => {
  form.addEventListener('submit', function() {
    const mainForm = document.querySelector('#mainForm');
    const inputs = mainForm.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if (!input.name) return;
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = input.name;
      hidden.value = input.value;
      this.appendChild(hidden);
    });
  });
});
</script>

{% endblock %}
