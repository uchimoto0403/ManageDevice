{% extends 'layout.html' %}
{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" 
      rel="stylesheet" 
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" 
      crossorigin="anonymous">

<div class="container" style="max-width:1200px;">
  <form action="{% url 'edit_device' struserid=struserid strdevid=device.id %}" method="post">
    {% csrf_token %}
    
    <!-- タイトル -->
    <div class="fs-4 text-center mb-4">
      <h1>機器編集</h1>
    </div>

    <!-- メッセージ表示 -->
    {% if messages %}
      {% for message in messages %}
        {% if message.tags == "success" %}
          <div class="alert alert-success text-center">{{ message }}</div>
        {% elif message.tags == "error" %}
          <div class="alert alert-danger text-center">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- 入力フォーム -->
    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">機器名：</label>
      <div class="col-4">{{ Form.chrDeviceName }}</div>
      <label class="col-2 col-form-label text-end">使用可否：</label>
      <div class="col-4">{{ Form.chrDeviceStatus }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">顧客名：</label>
      <div class="col-4">
        <select name="intCustomer" class="form-select" disabled>
          <option value="{{ device.dvcCustomer.id }}" selected>
            {{ device.dvcCustomer.usrName }}
          </option>
        </select>
<input type="hidden" name="intCustomer" value="{{ device.dvcCustomer.id }}">
      </div>
      <label class="col-2 col-form-label text-end">シリアル番号：</label>
      <div class="col-4">{{ Form.chrDeviceSerialNumber }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">媒体：</label>
      <div class="col-4">{{ Form.chrDeviceKind }}</div>
      <label class="col-2 col-form-label text-end">OS：</label>
      <div class="col-4">{{ Form.chrDeviceOS }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">メーカー：</label>
      <div class="col-4">{{ Form.chrDeviceMaker }}</div>
      <label class="col-2 col-form-label text-end">CPU：</label>
      <div class="col-4">{{ Form.chrDeviceCPU }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">型番：</label>
      <div class="col-4">{{ Form.chrDeviceModel }}</div>
      <label class="col-2 col-form-label text-end">RAM：</label>
      <div class="col-4">{{ Form.chrDeviceRAM }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">購入日：</label>
      <div class="col-4">{{ Form.dtDevicePurchase }}</div>
      <label class="col-2 col-form-label text-end">グラフィックカード：</label>
      <div class="col-4">{{ Form.chrDeviceGraphic }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">保証期限：</label>
      <div class="col-4">{{ Form.dtDeviceWarranty }}</div>
      <label class="col-2 col-form-label text-end">ストレージ：</label>
      <div class="col-4">{{ Form.chrDeviceStorage }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">使用者：</label>
      <div class="col-4">{{ Form.chrDeviceUser }}</div>
      <label class="col-2 col-form-label text-end">IPアドレス：</label>
      <div class="col-4">{{ Form.chrDeviceIP }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">設置場所：</label>
      <div class="col-4">{{ Form.chrDevicePlace }}</div>
      <label class="col-2 col-form-label text-end">ネットワーク：</label>
      <div class="col-4">{{ Form.chrDeviceNetwork }}</div>
    </div>

    <div class="row mb-3">
      <label class="col-2 col-form-label text-end">資産番号：</label>
      <div class="col-4">{{ Form.chrDeviceAssetNumber }}</div>
      <label class="col-2 col-form-label text-end">ソフト登録：</label>
      <div class="col-4">
        <button type="button" class="btn btn-info btn-sm w-100" data-bs-toggle="modal" data-bs-target="#softwareModal">
          ソフト登録
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <label class="col-2 col-form-label text-end">備考：</label>
      <div class="col-10">{{ Form.chrNotes }}</div>
    </div>

    <!-- ボタン群 -->
    <div class="row">
      <div class="col-12 d-flex justify-content-center">
        <div class="d-flex flex-column gap-3" style="width: 250px;">
          <button class="btn btn-primary w-100" type="submit" name="btnUpdateDevice">更新</button>
          <button class="btn btn-secondary w-100" type="submit" name="btnBack" formnovalidate>戻る</button>
          <button class="btn btn-danger w-100" type="submit" name="btnLogout" formnovalidate>ログアウト</button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- モーダル -->
<div class="modal fade" id="softwareModal" tabindex="-1" aria-labelledby="softwareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="softwareModalLabel">ソフト登録</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <div class="modal-body">

        <!-- 既存ソフト一覧（インライン編集形式） -->
        {% if temp_softs %}
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>ソフト名</th>
                <th>保証期限</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {% for soft in temp_softs %}
              <tr>
                <form method="post" action="{% url 'create_device' struserid=struserid %}">
                  {% csrf_token %}
                  <td>
                    <input type="text" name="chrSoftName" value="{{ soft.name }}" class="form-control">
                  </td>
                  <td>
                    <input type="date" name="chrWarranty" value="{{ soft.warranty }}" class="form-control">
                  </td>
                  <td>
                    <input type="hidden" name="soft_index" value="{{ forloop.counter0 }}">
                    <button type="submit" name="btnUpdateSoftTemp" class="btn btn-success btn-sm">保存</button>
                    <button type="submit" name="btnDeleteSoftTemp" class="btn btn-danger btn-sm">削除</button>
                  </td>
                </form>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="text-muted">一時保存されているソフトはありません。</p>
        {% endif %}

        <hr>

        <!-- 新規追加フォーム -->
        <form method="post" action="{% url 'create_device' struserid=struserid %}">
          {% csrf_token %}
          <div class="row mb-3">
            <div class="col-5">
              <input type="text" name="chrSoftName" class="form-control" placeholder="ソフト名">
            </div>
            <div class="col-5">
              <input type="date" name="chrWarranty" class="form-control">
            </div>
            <div class="col-2">
              <button type="submit" name="btnAddSoftTemp" class="btn btn-primary w-100">追加</button>
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}